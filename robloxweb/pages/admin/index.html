<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="/files/iziToast.min.css" />
    <style>
      [data-role] > div {
        border: 1px solid gray;
        width: 400px;
        padding: 10px;
      }
      p,
      h3 {
        margin: 0;
      }
      button {
        padding: 10px;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>–ó–∞–∫–∞–∑—ã —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–º</h1>
    <div data-role="transfer">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <h1>–ó–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ –≥—Ä—É–ø–ø—É</h1>
    <div data-role="group">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>
    <div data-role="config">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <input type="button" id="saveConfig" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" />

    <h2 style="margin-top:10px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    <p id="notSaved" style="display:none;color:red;font-weight:bold;">–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</p>
    <div data-role="promocodes"></div>
    <button id="addPromocode">–î–æ–±–∞–≤–∏—Ç—å</button>
    <input type="button" id="savePromocodes" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" />
    <button style="margin-top:10px" id="notify">–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏</button>
    <label for="toggleAutoGroup">–ê–≤—Ç–æ-–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã <input type="checkbox" id="toggleAutoGroup"/></label>
    <script
      src="/files/iziToast.min.js"
    ></script>
    <script>
let promocodesObj;
function groupBy(arr, property) {
  return arr.reduce(function(memo, x) {
    if (!memo[x[property]]) { memo[x[property]] = []; }
    memo[x[property]].push(x);
    return memo;
  }, {});
}
const getFormData = (props) => {
        const form = {};
        form.password = localStorage.getItem("password");
        if (props) {
          for (const key in props) {
            form[key] = props[key];
          }
        }
        return JSON.stringify(form);
      };
      const toggleDone = (id) => {
        const order = document.querySelector(`[data-id="${id}"]`);
        fetch("/admin/toggledone", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData({ id }),
        })
          .then((res) => res.json())
          .then((response) => {
            order.querySelector("button").innerText = response.done
              ? "üïí"
              : "‚úÖ";
          });
      };
      const copyLink = (placeID) => {
        navigator.clipboard
          .writeText(`https://www.roblox.com/games/${placeID}/`)
          .then(() => iziToast.show({ message: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ." }))
          .catch((err) => iziToast.error({ message: err }));
      };
      const deleteOrder = (id) => {
        const order = document.querySelector(`[data-id="${id}"]`);
        fetch("/admin", {
          method: "DELETE",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData({ id }),
        }).then((response) => {
          order.remove();
          const orders = document.querySelector('[data-role="orders"]');
          if (orders?.childElementCount === 0) {
            orders.innerHTML = "<p>–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç...</p>";
          }
        });
      };
      if (!localStorage.getItem("password")) {
        let password;
        while (!password) {
          password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.");
        }
        localStorage.setItem("password", password);
      }
      const containerGroup = document.querySelector('[data-role="group"]');
      const containerTransfer = document.querySelector('[data-role="transfer"]');
      fetch("/admin", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: getFormData(),
      })
        .then((res) => res.json())
        .then((response) => {
          const res = JSON.parse(response);
          console.log(res)
            const {group,transfer} = groupBy(res,'type');
            containerGroup.innerHTML = group?.length > 0 ? group.map(
              (obj) => {
                
            const dateObj = new Date(obj.date);
            const daysLeft = 16 - Math.ceil((new Date() - dateObj) / 8.64e7);
            return `
                <div data-id="${obj.id}">
                    <span>–ù–∏–∫–Ω–µ–π–º:</span>
                    <h3>${obj.username}</h3>
                    <p>–ó–∞–ø–ª–∞—á–µ–Ω–æ —Ä—É–±–ª–µ–π: ${obj.amount}‚ÇΩ</p><p>–ó–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω ${`${dateObj.getDate()}.${dateObj.getMonth() + 1}.${dateObj.getFullYear()}, ${dateObj.getHours()}:${dateObj.getMinutes()}`}</p>
                    <p>–†–æ–±—É–∫—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: ${obj.amountOfRobux} : ${obj.times} —Ä–∞–∑ –ø–æ ${obj.optimal}</p><p>–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞${daysLeft > 0 ? ` —á–µ—Ä–µ–∑ ${16 - Math.ceil((new Date() - dateObj) / 8.64e7)} –¥–Ω–µ–π` : ''}</p>
                    ${obj.hasPromocode ? '<p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–æ–º–æ–∫–æ–¥</p>' : ''}
                    <div style="display:flex">
                        <button onclick="toggleDone('${obj.id}')" data-done="${
                obj.done
              }">${obj.done ? "üïí" : "‚úÖ"}</button>
                        <button onclick="deleteOrder('${obj.id}')">üóëÔ∏è</button>

                        ${daysLeft <= 0 && !obj.done ?  `<button class="sendrobuxes" onclick="sendRobuxes(${obj.id})">üí∞</button>` : ''}
                    </div>
                </div>
                `}
            )
          : "<p>–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç...</p>";
          containerTransfer.innerHTML = transfer?.length > 0 ? transfer.map(
              (obj) => `
                <div data-id="${obj.id}">
                    <span>–ù–∏–∫–Ω–µ–π–º:</span>
                    <h3>${obj.username}</h3>
                    <p>–ó–∞–ø–ª–∞—á–µ–Ω–æ —Ä—É–±–ª–µ–π: ${obj.amount}‚ÇΩ</p>
                    <p>–†–æ–±—É–∫—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: ${obj.amountOfRobux} : ${obj.times} —Ä–∞–∑ –ø–æ ${obj.optimal}</p>
                    ${obj.hasPromocode ? '<p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–æ–º–æ–∫–æ–¥</p>' : ''}
                    <div style="display:flex">
                        <button onclick="toggleDone('${obj.id}')" data-done="${
                obj.done
              }">${obj.done ? "üïí" : "‚úÖ"}</button>
                        <button onclick="deleteOrder('${obj.id}')">üóëÔ∏è</button>
                        <button onclick="copyLink(${obj.placeID})">üîó</button>
                    </div>
                </div>
                `
            )
          : "<p>–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç...</p>";
          
        });
      fetch("/admin/config", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: getFormData(),
      })
        .then((res) => res.json())
        .then((res) => {
          console.log(res);
          const {promocodes,autoGroup,autoTransfer,...config} = res;
          let innerConfig = "";
          for (const [key, value] of Object.entries(config)) {
            innerConfig += `
            <div>
              <label for="${key}">${key}</label>
              <input id="${key}" type="text" value="${value}"/>
            </div>
            `;
          }
          document.querySelector('[data-role="config"]').innerHTML = innerConfig;
          promocodesObj = [...promocodes]
          let i = 0;
          let innerPromocodes = ''
          for(const promocode of promocodes){
            innerPromocodes += `
            <div data-id="${i}" data-promocode-value="${promocode.value}">
              <p>–°–ª–æ–≤–æ: <input data-type="value" oninput="changePromocode(${i},'value',this.value)" type="text" value="${promocode.value}"/></p>
              <p>–°–∫–∏–¥–∫–∞: <input data-type="discount" oninput="changePromocode(${i},'discount',this.value)" type="text" value="${promocode.discount}"/>%</p>
              <button onclick="deletePromocode('${promocode.value}')">üóëÔ∏è</button>
            </div>
            `
            i++
          }
          document.querySelector('[data-role="promocodes"]').innerHTML = innerPromocodes;
          if(autoGroup){
            document.getElementById('toggleAutoGroup').checked = true;
          }
        });
        document.getElementById('toggleAutoGroup').addEventListener('change',({target})=>{
          fetch("/admin/togglegroupjobs", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: getFormData(),
      }).then(res => res.json()).then(res => {
        iziToast.show({message:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.'})
      })
        })
        function changePromocode(id,prop,value){
         
          promocodesObj[id][prop] = value;
         
            
          document.getElementById('notSaved').style.display = 'block';
          
        }
        function deletePromocode(value){
          promocodesObj = promocodesObj.filter(promocode => promocode.value !== value);
          document.querySelector(`[data-promocode-value="${value}"]`).remove()
         
          document.getElementById('notSaved').style.display = 'block';
        }
        document.getElementById('addPromocode').addEventListener('click',()=>{
          const value = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ:')
          const discount = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–∫–∏–¥–∫—É –≤ —Ü–∏—Ñ—Ä–∞—Ö –æ—Ç 1 –¥–æ 100');
          promocodesObj.push({value,discount});
          const div = document.createElement('div')
          div.dataset.promocodeValue = value;
          div.innerHTML = `<p>–°–ª–æ–≤–æ: <input type="text" value="${value}"/></p>
              <p>–°–∫–∏–¥–∫–∞: <input type="text" value="${discount}"/>%</p>
              <button onclick="deletePromocode('${value}')">üóëÔ∏è</button>`
              document.querySelector('[data-role="promocodes"]').appendChild(div)
          document.getElementById('notSaved').style.display = 'block';
        })
        document.getElementById('savePromocodes').addEventListener('click',()=>{
          fetch("/admin/config", {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData({ config: {promocodes:promocodesObj} }),
        }).then(() => {
          iziToast.show({message:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"});
          
          document.getElementById('notSaved').style.display = 'none';
        });
        })
      document.getElementById("saveConfig").addEventListener("click", () => {
        const arr = {};
        document
          .querySelectorAll('[data-role="config"] div')
          .forEach((elem) => {
            arr[elem.querySelector("label").innerText] =
              elem.querySelector("input").value;
          });
        fetch("/admin/config", {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData({ config: arr }),
        }).then(() => {
          iziToast.show({ message:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"});
        });
      });
      const sendRobuxes = (id)=>{
        fetch("/admin/sendrobuxesgroup", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData({orderID:id}),
        }).then(res => res.json()).then(res => {
          console.log(res)
          if(res.message === 'ok'){

          iziToast.show({ message:"–†–æ–±—É–∫—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã."});
          document.querySelector(`[data-id="${id}"] .sendrobuxes`).outerHTML = ''
          document.querySelector(`[data-id="${id}"] [data-done]`).innerText = 'üïí'
          } else{
            
          iziToast.show({ message:"–û—à–∏–±–∫–∞"});
          }
        });
      }
      document.getElementById('notify').addEventListener('click',()=>{
        fetch("/admin/notify", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: getFormData(),
        }).then(() => {
          iziToast.show({ message:"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."});
        });
      })
    </script>
  </body>
</html>
